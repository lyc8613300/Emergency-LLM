<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency-LLM æ¨¡å‹å¾®è°ƒå¹³å°</title>
    <!-- å¼•å…¥Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- å¼•å…¥Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab-button {
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(102, 126, 234, 0.3);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .input-field {
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
            }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-idle {
            background: #9ca3af;
        }
        
        .status-training {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-error {
            background: #ef4444;
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-2xl font-bold text-white">ğŸš‘ Emergency-LLM</h1>
                    </div>
                    <div class="ml-10 flex items-center space-x-4">
                        <span class="text-white text-sm font-medium">æ¨¡å‹å¾®è°ƒå¹³å°</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <span class="status-indicator status-idle" id="statusIndicator"></span>
                        <span class="text-white text-sm" id="statusText">ç©ºé—²</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- æ ‡ç­¾é¡µ -->
        <div class="mb-6">
            <div class="flex space-x-2 bg-white rounded-lg p-1 shadow">
                <button class="tab-button active flex-1 py-3 px-4 rounded-md font-medium text-gray-700" 
                        onclick="switchTab('train')" id="trainTab">
                    ğŸ“š è®­ç»ƒé…ç½®
                </button>
                <button class="tab-button flex-1 py-3 px-4 rounded-md font-medium text-gray-700" 
                        onclick="switchTab('monitor')" id="monitorTab">
                    ğŸ“Š è®­ç»ƒç›‘æ§
                </button>
                <button class="tab-button flex-1 py-3 px-4 rounded-md font-medium text-gray-700" 
                        onclick="switchTab('export')" id="exportTab">
                    ğŸ’¾ æ¨¡å‹å¯¼å‡º
                </button>
            </div>
        </div>

        <!-- è®­ç»ƒé…ç½®æ ‡ç­¾é¡µ -->
        <div id="trainContent" class="tab-content">
            <div class="grid grid-cols-1 gap-6">
                <!-- æ¨¡å‹é…ç½®å¡ç‰‡ -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg p-2 mr-3">ğŸ¤–</span>
                        æ¨¡å‹é…ç½®
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ¨¡å‹åç§°</label>
                            <select id="modelName" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">é€‰æ‹©æ¨¡å‹...</option>
                                <option value="llama3">LLaMA-3</option>
                                <option value="qwen">Qwen</option>
                                <option value="chatglm">ChatGLM</option>
                                <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ¨¡å‹è·¯å¾„</label>
                            <input type="text" id="modelPath" placeholder="/path/to/model" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¾®è°ƒç±»å‹</label>
                            <select id="finetuningType" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="lora">LoRA</option>
                                <option value="full">å…¨å‚æ•°å¾®è°ƒ</option>
                                <option value="freeze">å†»ç»“å¾®è°ƒ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é‡åŒ–æ–¹å¼</label>
                            <select id="quantizationBit" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="none">æ— é‡åŒ–</option>
                                <option value="8">8-bit</option>
                                <option value="4">4-bit</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ¨¡æ¿ç±»å‹</label>
                            <select id="template" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="default">é»˜è®¤</option>
                                <option value="llama3">LLaMA-3</option>
                                <option value="qwen">Qwen</option>
                                <option value="chatglm">ChatGLM</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åŠ é€Ÿå™¨</label>
                            <select id="booster" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="auto">è‡ªåŠ¨</option>
                                <option value="flashattn2">FlashAttention-2</option>
                                <option value="unsloth">Unsloth</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- æ•°æ®é…ç½®å¡ç‰‡ -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg p-2 mr-3">ğŸ“</span>
                        æ•°æ®é…ç½®
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è®­ç»ƒé˜¶æ®µ</label>
                            <select id="trainingStage" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="sft">ç›‘ç£å¾®è°ƒ (SFT)</option>
                                <option value="pt">é¢„è®­ç»ƒ (PT)</option>
                                <option value="rm">å¥–åŠ±å»ºæ¨¡ (RM)</option>
                                <option value="ppo">PPOè®­ç»ƒ</option>
                                <option value="dpo">DPOè®­ç»ƒ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®é›†ç›®å½•</label>
                            <input type="text" id="datasetDir" value="data" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®é›†é€‰æ‹©</label>
                            <div class="relative">
                                <div class="relative">
                                    <input type="text" id="dataset" placeholder="ç‚¹å‡»é€‰æ‹©æ•°æ®é›†æˆ–æ‰‹åŠ¨è¾“å…¥æ•°æ®é›†åç§°ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰" 
                                           onclick="toggleDatasetList()"
                                           oninput="syncDatasetSelection()"
                                           class="input-field w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <svg id="datasetDropdownIcon" class="w-5 h-5 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- ä¸‹æ‹‰æ•°æ®é›†åˆ—è¡¨ -->
                                <div id="datasetListContainer" 
                                     class="hidden absolute z-10 w-full mt-1 max-h-64 overflow-y-auto custom-scrollbar border border-gray-300 rounded-lg p-3 bg-white shadow-lg">
                                    <p class="text-sm text-gray-500">æ­£åœ¨åŠ è½½æ•°æ®é›†åˆ—è¡¨...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŸºç¡€è®­ç»ƒå‚æ•°å¡ç‰‡ -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg p-2 mr-3">âš™ï¸</span>
                        åŸºç¡€è®­ç»ƒå‚æ•°
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ ç‡</label>
                            <input type="text" id="learningRate" value="5e-5" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è®­ç»ƒè½®æ•°</label>
                            <input type="text" id="numTrainEpochs" value="3.0" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å¤§æ¢¯åº¦èŒƒæ•°</label>
                            <input type="text" id="maxGradNorm" value="1.0" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åºåˆ—é•¿åº¦ (cutoff_len)</label>
                            <input type="number" id="cutoffLen" value="2048" min="4" max="131072" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰¹æ¬¡å¤§å° (batch_size)</label>
                            <input type="number" id="batchSize" value="2" min="1" max="1024" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ¢¯åº¦ç´¯ç§¯æ­¥æ•°</label>
                            <input type="number" id="gradientAccumulation" value="8" min="1" max="1024" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">éªŒè¯é›†æ¯”ä¾‹</label>
                            <input type="number" id="valSize" value="0" min="0" max="1" step="0.01" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å­¦ä¹ ç‡è°ƒåº¦å™¨</label>
                            <select id="lrScheduler" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="cosine">ä½™å¼¦é€€ç«</option>
                                <option value="linear">çº¿æ€§</option>
                                <option value="constant">å¸¸é‡</option>
                                <option value="polynomial">å¤šé¡¹å¼</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è®¡ç®—ç²¾åº¦</label>
                            <select id="computeType" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="bf16">BF16</option>
                                <option value="fp16">FP16</option>
                                <option value="fp32">FP32</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- LoRAé…ç½® -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg p-2 mr-3">ğŸ¯</span>
                        LoRA é…ç½®
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">LoRA Rank</label>
                                <input type="number" id="loraRank" value="8" min="1" max="1024" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">LoRA Alpha</label>
                                <input type="number" id="loraAlpha" value="16" min="1" max="2048" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">LoRA Dropout</label>
                                <input type="number" id="loraDropout" value="0" min="0" max="1" step="0.01" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">LoRA Target æ¨¡å—</label>
                                <input type="text" id="loraTarget" placeholder="all æˆ– q_proj,v_proj" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div class="flex items-center space-x-6">
                                <label class="flex items-center">
                                    <input type="checkbox" id="useRslora" class="rounded text-purple-600 focus:ring-purple-500 mr-2">
                                    <span class="text-sm text-gray-700">ä½¿ç”¨ RSLoRA</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="useDora" class="rounded text-purple-600 focus:ring-purple-500 mr-2">
                                    <span class="text-sm text-gray-700">ä½¿ç”¨ DoRA</span>
                                </label>
                            </div>
                        </div>
                </div>

                <!-- é«˜çº§é€‰é¡¹ -->
                <div class="bg-white rounded-xl shadow-md p-6 card-hover">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg p-2 mr-3">ğŸ”§</span>
                        é«˜çº§é€‰é¡¹
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥å¿—æ­¥æ•°</label>
                                <input type="number" id="loggingSteps" value="5" min="1" max="1000" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ä¿å­˜æ­¥æ•°</label>
                                <input type="number" id="saveSteps" value="100" min="10" max="5000" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">é¢„çƒ­æ­¥æ•°</label>
                                <input type="number" id="warmupSteps" value="0" min="0" max="5000" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è¾“å‡ºç›®å½•</label>
                                <input type="text" id="outputDir" placeholder="saves/emergency-llm" 
                                       class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">DeepSpeedé˜¶æ®µ</label>
                                <select id="dsStage" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="none">ä¸ä½¿ç”¨</option>
                                    <option value="2">é˜¶æ®µ2</option>
                                    <option value="3">é˜¶æ®µ3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">æŠ¥å‘Šå·¥å…·</label>
                                <select id="reportTo" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <option value="none">æ— </option>
                                    <option value="tensorboard">TensorBoard</option>
                                    <option value="wandb">W&B</option>
                                    <option value="all">å…¨éƒ¨</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="packing" class="rounded text-purple-600 focus:ring-purple-500 mr-2">
                                <span class="text-sm text-gray-700">å¯ç”¨ Packing</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="trainOnPrompt" class="rounded text-purple-600 focus:ring-purple-500 mr-2">
                                <span class="text-sm text-gray-700">è®­ç»ƒæç¤ºè¯</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="resizeVocab" class="rounded text-purple-600 focus:ring-purple-500 mr-2">
                                <span class="text-sm text-gray-700">è°ƒæ•´è¯è¡¨</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="dsOffload" class="rounded text-purple-600 focus:ring-purple-500 mr-2">
                                <span class="text-sm text-gray-700">DeepSpeedå¸è½½</span>
                            </label>
                        </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex flex-wrap gap-4">
                        <button onclick="previewConfig()" 
                                class="flex-1 min-w-[200px] px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                            ğŸ‘ï¸ é¢„è§ˆé…ç½®
                        </button>
                        <button onclick="saveConfig()" 
                                class="flex-1 min-w-[200px] px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                            ğŸ’¾ ä¿å­˜é…ç½®
                        </button>
                        <button onclick="loadConfig()" 
                                class="flex-1 min-w-[200px] px-6 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-medium">
                            ğŸ“‚ åŠ è½½é…ç½®
                        </button>
                        <button onclick="startTraining()" id="startBtn"
                                class="flex-1 min-w-[200px] px-6 py-3 btn-primary text-white rounded-lg font-medium pulse-glow">
                            ğŸš€ å¼€å§‹è®­ç»ƒ
                        </button>
                        <button onclick="stopTraining()" id="stopBtn"
                                class="flex-1 min-w-[200px] px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium" disabled>
                            â¹ï¸ åœæ­¢è®­ç»ƒ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®­ç»ƒç›‘æ§æ ‡ç­¾é¡µ -->
        <div id="monitorContent" class="tab-content hidden">
            <div class="grid grid-cols-1 gap-6">
                <!-- è®­ç»ƒçŠ¶æ€å¡ç‰‡ -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg p-2 mr-3">ğŸ“Š</span>
                        è®­ç»ƒçŠ¶æ€
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="currentEpoch">0</div>
                            <div class="text-sm text-gray-600">å½“å‰è½®æ¬¡</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="currentStep">0</div>
                            <div class="text-sm text-gray-600">å½“å‰æ­¥æ•°</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="currentLoss">-</div>
                            <div class="text-sm text-gray-600">å½“å‰Loss</div>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="trainingTime">00:00:00</div>
                            <div class="text-sm text-gray-600">è®­ç»ƒæ—¶é•¿</div>
                        </div>
                    </div>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">è®­ç»ƒè¿›åº¦</h3>
                    <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-500" 
                             id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-sm text-gray-600 mt-2 text-right" id="progressText">0%</div>
                </div>

                <!-- è®­ç»ƒæ—¥å¿— -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg p-2 mr-3">ğŸ“</span>
                        è®­ç»ƒæ—¥å¿—
                    </h2>
                    <div class="bg-gray-900 rounded-lg p-4 h-96 overflow-y-auto custom-scrollbar font-mono text-sm" id="logContainer">
                        <div class="text-green-400">> ç­‰å¾…å¼€å§‹è®­ç»ƒ...</div>
                    </div>
                </div>

                <!-- Lossæ›²çº¿å›¾ -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-2 mr-3">ğŸ“ˆ</span>
                        Training Loss Curve
                    </h2>
                    <div class="h-96 bg-white rounded-lg border border-gray-200 p-4">
                        <canvas id="lossChart"></canvas>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 text-center">
                        <span class="inline-block">
                            <span class="inline-block w-3 h-3 rounded-full bg-blue-600 mr-1"></span>
                            è®­ç»ƒæŸå¤±
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡å‹å¯¼å‡ºæ ‡ç­¾é¡µ -->
        <div id="exportContent" class="tab-content hidden">
            <div class="grid grid-cols-1 gap-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg p-2 mr-3">ğŸ’¾</span>
                        æ¨¡å‹å¯¼å‡ºé…ç½®
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¯¼å‡ºæ ¼å¼</label>
                            <select id="exportFormat" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="huggingface">HuggingFace</option>
                                <option value="gguf">GGUF</option>
                                <option value="vllm">vLLM</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¯¼å‡ºè·¯å¾„</label>
                            <input type="text" id="exportPath" placeholder="exports/emergency-llm" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ£€æŸ¥ç‚¹è·¯å¾„</label>
                            <input type="text" id="checkpointPath" placeholder="saves/checkpoint-1000" 
                                   class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é‡åŒ–ç²¾åº¦</label>
                            <select id="exportQuantization" class="input-field w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="none">ä¸é‡åŒ–</option>
                                <option value="8bit">8-bit</option>
                                <option value="4bit">4-bit</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex gap-4">
                        <button onclick="exportModel()" 
                                class="flex-1 px-6 py-3 btn-primary text-white rounded-lg font-medium">
                            ğŸ“¦ å¯¼å‡ºæ¨¡å‹
                        </button>
                        <button onclick="mergeAdapters()" 
                                class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                            ğŸ”— åˆå¹¶é€‚é…å™¨
                        </button>
                    </div>
                </div>

                <!-- å¯¼å‡ºæ—¥å¿— -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">å¯¼å‡ºæ—¥å¿—</h2>
                    <div class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto custom-scrollbar font-mono text-sm" id="exportLogContainer">
                        <div class="text-green-400">> ç­‰å¾…å¯¼å‡ºæ“ä½œ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.jsåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let trainingInterval = null;
        let trainingStartTime = null;
        let lossChart = null;
        let lossData = [];
        let lossSteps = [];

        // åˆå§‹åŒ–Losså›¾è¡¨ï¼ˆæ¨¡ä»¿LLaMA-Factoryæ ·å¼ï¼‰
        function initLossChart() {
            const ctx = document.getElementById('lossChart').getContext('2d');
            lossChart = new Chart(ctx, {
                type: 'scatter',  // ä½¿ç”¨ scatter ç±»å‹æ”¯æŒ {x, y} æ•°æ®æ ¼å¼
                data: {
                    datasets: [
                        {
                            label: 'loss',
                            data: [],
                            borderColor: 'rgb(31, 119, 180)',  // LLaMA-Factory è“è‰²
                            backgroundColor: 'rgba(31, 119, 180, 0.1)',
                            borderWidth: 2.5,
                            pointRadius: 0,  // ä¸æ˜¾ç¤ºç‚¹
                            pointHoverRadius: 4,
                            showLine: true,  // scatter ç±»å‹éœ€è¦æ˜¾å¼å¯ç”¨çº¿æ¡
                            tension: 0,  // ç›´çº¿
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0  // ç¦ç”¨åŠ¨ç”»ï¼Œæé«˜æ€§èƒ½
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'start',
                            labels: {
                                boxWidth: 40,
                                boxHeight: 2,
                                padding: 10,
                                font: {
                                    size: 11,
                                    family: 'Arial, sans-serif'
                                }
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            display: true,
                            title: {
                                display: true,
                                text: 'step',
                                font: {
                                    size: 11,
                                    family: 'Arial, sans-serif'
                                }
                            },
                            grid: {
                                display: true,
                                drawBorder: true,
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxTicksLimit: 10,  // matplotlib é»˜è®¤çº¦10ä¸ªåˆ»åº¦
                                autoSkip: true,
                                autoSkipPadding: 10
                            },
                            // ä»æ•°æ®æœ€å°å€¼å¼€å§‹ï¼ˆé€šå¸¸æ˜¯step 0æˆ–ç¬¬ä¸€ä¸ªstepï¼‰
                            min: undefined,
                            max: undefined,
                            // å‡å°‘è¾¹è·ï¼Œè®©èµ·ç‚¹æ›´è´´è¿‘åæ ‡è½´
                            grace: '2%'
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            title: {
                                display: true,
                                text: 'loss',
                                font: {
                                    size: 11,
                                    family: 'Arial, sans-serif'
                                }
                            },
                            beginAtZero: false,  // ä¸ä»0å¼€å§‹ï¼Œä»æ•°æ®æœ€å°å€¼å¼€å§‹
                            grid: {
                                display: true,
                                drawBorder: true,
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxTicksLimit: 10,  // matplotlib é»˜è®¤çº¦10ä¸ªåˆ»åº¦
                                autoSkip: true,
                                autoSkipPadding: 10
                            },
                            // è‡ªåŠ¨è®¡ç®—èŒƒå›´ï¼Œç±»ä¼¼ matplotlib
                            min: undefined,
                            max: undefined,
                            // Yè½´æ·»åŠ 5%è¾¹è·ä»¥ç•™å‡ºç©ºé—´
                            grace: '5%'
                        }
                    }
                }
            });
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // æ”¶é›†è®­ç»ƒé…ç½®
        function collectConfig() {
            // è·å–æ•°æ®é›†ï¼šä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é€‰ä¸­çš„æ•°æ®é›†
            const manualDatasets = document.getElementById('dataset').value.trim();
            let datasets = [];
            
            if (manualDatasets) {
                // æ‰‹åŠ¨è¾“å…¥çš„æ•°æ®é›†
                datasets = manualDatasets.split(',').map(s => s.trim()).filter(s => s);
            } else if (selectedDatasets.size > 0) {
                // å¤é€‰æ¡†é€‰ä¸­çš„æ•°æ®é›†
                datasets = Array.from(selectedDatasets);
            }
            
            return {
                // æ¨¡å‹é…ç½®
                model_name: document.getElementById('modelName').value,
                model_path: document.getElementById('modelPath').value,
                finetuning_type: document.getElementById('finetuningType').value,
                quantization_bit: document.getElementById('quantizationBit').value,
                template: document.getElementById('template').value,
                booster: document.getElementById('booster').value,
                
                // æ•°æ®é…ç½®
                training_stage: document.getElementById('trainingStage').value,
                dataset_dir: document.getElementById('datasetDir').value,
                dataset: datasets,
                
                // åŸºç¡€å‚æ•°
                learning_rate: parseFloat(document.getElementById('learningRate').value),
                num_train_epochs: parseFloat(document.getElementById('numTrainEpochs').value),
                max_grad_norm: parseFloat(document.getElementById('maxGradNorm').value),
                cutoff_len: parseInt(document.getElementById('cutoffLen').value),
                batch_size: parseInt(document.getElementById('batchSize').value),
                gradient_accumulation_steps: parseInt(document.getElementById('gradientAccumulation').value),
                val_size: parseFloat(document.getElementById('valSize').value),
                lr_scheduler_type: document.getElementById('lrScheduler').value,
                compute_type: document.getElementById('computeType').value,
                
                // LoRAé…ç½®
                lora_rank: parseInt(document.getElementById('loraRank').value),
                lora_alpha: parseInt(document.getElementById('loraAlpha').value),
                lora_dropout: parseFloat(document.getElementById('loraDropout').value),
                lora_target: document.getElementById('loraTarget').value,
                use_rslora: document.getElementById('useRslora').checked,
                use_dora: document.getElementById('useDora').checked,
                
                // é«˜çº§é€‰é¡¹
                logging_steps: parseInt(document.getElementById('loggingSteps').value),
                save_steps: parseInt(document.getElementById('saveSteps').value),
                warmup_steps: parseInt(document.getElementById('warmupSteps').value),
                output_dir: document.getElementById('outputDir').value,
                ds_stage: document.getElementById('dsStage').value,
                ds_offload: document.getElementById('dsOffload').checked,
                report_to: document.getElementById('reportTo').value,
                packing: document.getElementById('packing').checked,
                train_on_prompt: document.getElementById('trainOnPrompt').checked,
                resize_vocab: document.getElementById('resizeVocab').checked,
            };
        }

        // é¢„è§ˆé…ç½®
        function previewConfig() {
            const config = collectConfig();
            alert('è®­ç»ƒé…ç½®é¢„è§ˆ:\n\n' + JSON.stringify(config, null, 2));
            console.log('Training Config:', config);
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const config = collectConfig();
            const configJson = JSON.stringify(config, null, 2);
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([configJson], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'training_config.json';
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('é…ç½®å·²ä¿å­˜åˆ° training_config.json');
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const config = JSON.parse(event.target.result);
                        // å¡«å……è¡¨å•
                        Object.keys(config).forEach(key => {
                            const element = document.getElementById(key.replace(/_([a-z])/g, (g) => g[1].toUpperCase()));
                            if (element) {
                                if (element.type === 'checkbox') {
                                    element.checked = config[key];
                                } else if (Array.isArray(config[key])) {
                                    element.value = config[key].join(', ');
                                } else {
                                    element.value = config[key];
                                }
                            }
                        });
                        addLog('é…ç½®åŠ è½½æˆåŠŸ');
                    } catch (error) {
                        alert('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // å¼€å§‹è®­ç»ƒ
        async function startTraining() {
            const config = collectConfig();
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!config.model_name || !config.model_path) {
                alert('è¯·å¡«å†™æ¨¡å‹åç§°å’Œæ¨¡å‹è·¯å¾„ï¼');
                return;
            }
            
            if (!config.dataset || config.dataset.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ•°æ®é›†ï¼');
                return;
            }
            
            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('statusIndicator').className = 'status-indicator status-training';
            document.getElementById('statusText').textContent = 'è®­ç»ƒä¸­';
            
            // åˆ‡æ¢åˆ°ç›‘æ§æ ‡ç­¾é¡µ
            switchTab('monitor');
            
            // æ¸…ç©ºæ—¥å¿—å’Œå›¾è¡¨
            document.getElementById('logContainer').innerHTML = '';
            lossData = [];
            lossSteps = [];
            if (lossChart) {
                lossChart.data.datasets[0].data = [];
                lossChart.update();
            }
            
            addLog('æ­£åœ¨åˆå§‹åŒ–è®­ç»ƒ...');
            addLog('è®­ç»ƒé…ç½®: ' + JSON.stringify(config, null, 2));
            
            try {
                // è°ƒç”¨åç«¯APIå¼€å§‹è®­ç»ƒ
                const response = await fetch('/api/train/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) {
                    throw new Error('å¯åŠ¨è®­ç»ƒå¤±è´¥');
                }
                
                const result = await response.json();
                addLog('è®­ç»ƒå·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ' + result.task_id);
                
                // å¼€å§‹ç›‘æ§è®­ç»ƒçŠ¶æ€
                trainingStartTime = Date.now();
                startMonitoring(result.task_id);
                
            } catch (error) {
                addLog('é”™è¯¯: ' + error.message, 'error');
                resetTrainingUI();
            }
        }

        // åœæ­¢è®­ç»ƒ
        async function stopTraining() {
            try {
                const response = await fetch('/api/train/stop', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    addLog('è®­ç»ƒå·²åœæ­¢');
                    resetTrainingUI();
                }
            } catch (error) {
                addLog('åœæ­¢è®­ç»ƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¼€å§‹ç›‘æ§è®­ç»ƒçŠ¶æ€
        function startMonitoring(taskId) {
            trainingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/train/status?task_id=' + taskId);
                    const status = await response.json();
                    
                    // æ›´æ–°è®­ç»ƒçŠ¶æ€
                    updateTrainingStatus(status);
                    
                    // å¦‚æœè®­ç»ƒå®Œæˆæˆ–å‡ºé”™ï¼Œåœæ­¢ç›‘æ§
                    if (status.status === 'completed' || status.status === 'error') {
                        clearInterval(trainingInterval);
                        resetTrainingUI();
                        
                        if (status.status === 'completed') {
                            addLog('è®­ç»ƒå®Œæˆï¼');
                            document.getElementById('statusIndicator').className = 'status-indicator status-idle';
                            document.getElementById('statusText').textContent = 'å®Œæˆ';
                        } else {
                            addLog('è®­ç»ƒå‡ºé”™: ' + status.error, 'error');
                            document.getElementById('statusIndicator').className = 'status-indicator status-error';
                            document.getElementById('statusText').textContent = 'é”™è¯¯';
                        }
                    }
                } catch (error) {
                    console.error('è·å–è®­ç»ƒçŠ¶æ€å¤±è´¥:', error);
                }
            }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
        }

        // æ›´æ–°è®­ç»ƒçŠ¶æ€æ˜¾ç¤º
        function updateTrainingStatus(status) {
            if (status.epoch !== undefined) {
                document.getElementById('currentEpoch').textContent = status.epoch;
            }
            if (status.step !== undefined) {
                document.getElementById('currentStep').textContent = status.step;
            }
            if (status.loss !== undefined) {
                document.getElementById('currentLoss').textContent = status.loss.toFixed(4);
                
                // æ›´æ–°Losså›¾è¡¨ï¼ˆæ¨¡ä»¿LLaMA-Factoryï¼šåŸå§‹+å¹³æ»‘ï¼‰
                // æ³¨æ„ï¼šä½¿ç”¨ !== undefined è€Œä¸æ˜¯ç›´æ¥åˆ¤æ–­ï¼Œè¿™æ · step 0 ä¹Ÿä¼šè¢«å¤„ç†
                if (lossChart && status.step !== undefined) {
                    // åªåœ¨stepå˜åŒ–æ—¶æ‰æ·»åŠ æ–°æ•°æ®ç‚¹ï¼Œé¿å…é‡å¤
                    const lastStep = lossSteps.length > 0 ? lossSteps[lossSteps.length - 1] : -1;
                    
                    if (status.step !== lastStep) {
                        // æ·»åŠ æ–°çš„æ•°æ®ç‚¹
                        lossSteps.push(status.step);
                        lossData.push(status.loss);
                        
                        // é™åˆ¶æ•°æ®ç‚¹æ•°é‡ï¼ˆä¿ç•™æœ€è¿‘300ä¸ªç‚¹ï¼‰
                        const maxPoints = 300;
                        if (lossSteps.length > maxPoints) {
                            lossSteps.shift();
                            lossData.shift();
                        }
                    } else {
                        // å¦‚æœæ˜¯ç›¸åŒçš„stepï¼Œæ›´æ–°æœ€åä¸€ä¸ªæ•°æ®ç‚¹çš„losså€¼ï¼ˆå–æœ€æ–°çš„ï¼‰
                        if (lossData.length > 0) {
                            lossData[lossData.length - 1] = status.loss;
                        }
                    }
                    
                    // è½¬æ¢ä¸º {x, y} æ ¼å¼ï¼Œæ”¯æŒçº¿æ€§åæ ‡è½´
                    const chartData = lossSteps.map((step, i) => ({
                        x: step,
                        y: lossData[i]
                    }));
                    
                    // æ›´æ–°å›¾è¡¨æ•°æ®
                    lossChart.data.datasets[0].data = chartData;
                    
                    // æ›´æ–°å›¾è¡¨ï¼ˆä¸ä½¿ç”¨åŠ¨ç”»ï¼‰
                    lossChart.update('none');
                }
            }
            if (status.progress !== undefined) {
                const progress = Math.round(status.progress * 100);
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressText').textContent = progress + '%';
            }
            
            // æ›´æ–°è®­ç»ƒæ—¶é•¿
            if (trainingStartTime) {
                const elapsed = Date.now() - trainingStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('trainingTime').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            // æ·»åŠ æ–°æ—¥å¿—
            if (status.logs && status.logs.length > 0) {
                status.logs.forEach(log => addLog(log));
            }
        }

        // é‡ç½®è®­ç»ƒUIçŠ¶æ€
        function resetTrainingUI() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            if (trainingInterval) {
                clearInterval(trainingInterval);
                trainingInterval = null;
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            
            const timestamp = new Date().toLocaleTimeString();
            let color = 'text-green-400';
            let prefix = '>';
            
            if (type === 'error') {
                color = 'text-red-400';
                prefix = 'âœ—';
            } else if (type === 'warning') {
                color = 'text-yellow-400';
                prefix = 'âš ';
            } else if (type === 'success') {
                color = 'text-blue-400';
                prefix = 'âœ“';
            }
            
            logEntry.className = color;
            logEntry.textContent = `[${timestamp}] ${prefix} ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // å¯¼å‡ºæ¨¡å‹
        async function exportModel() {
            const config = {
                format: document.getElementById('exportFormat').value,
                export_path: document.getElementById('exportPath').value,
                checkpoint_path: document.getElementById('checkpointPath').value,
                quantization: document.getElementById('exportQuantization').value
            };
            
            // éªŒè¯å¿…å¡«å‚æ•°
            if (!config.checkpoint_path || !config.checkpoint_path.trim()) {
                addExportLog('âŒ é”™è¯¯: è¯·å¡«å†™æ£€æŸ¥ç‚¹è·¯å¾„', 'error');
                alert('è¯·å¡«å†™æ£€æŸ¥ç‚¹è·¯å¾„ï¼');
                return;
            }
            
            if (!config.export_path || !config.export_path.trim()) {
                addExportLog('âŒ é”™è¯¯: è¯·å¡«å†™å¯¼å‡ºè·¯å¾„', 'error');
                alert('è¯·å¡«å†™å¯¼å‡ºè·¯å¾„ï¼');
                return;
            }
            
            addExportLog('å¼€å§‹å¯¼å‡ºæ¨¡å‹...');
            addExportLog('å¯¼å‡ºé…ç½®: ' + JSON.stringify(config, null, 2));
            
            try {
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) {
                    throw new Error('å¯¼å‡ºå¤±è´¥');
                }
                
                const result = await response.json();
                addExportLog('å¯¼å‡ºæˆåŠŸ: ' + result.message);
                
            } catch (error) {
                addExportLog('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆå¹¶é€‚é…å™¨
        async function mergeAdapters() {
            const checkpointPath = document.getElementById('checkpointPath').value.trim();
            const exportPath = document.getElementById('exportPath').value.trim();
            
            // éªŒè¯å¿…å¡«å‚æ•°
            if (!checkpointPath) {
                addExportLog('âŒ é”™è¯¯: è¯·å¡«å†™æ£€æŸ¥ç‚¹è·¯å¾„', 'error');
                alert('è¯·å¡«å†™æ£€æŸ¥ç‚¹è·¯å¾„ï¼');
                return;
            }
            
            if (!exportPath) {
                addExportLog('âŒ é”™è¯¯: è¯·å¡«å†™å¯¼å‡ºè·¯å¾„', 'error');
                alert('è¯·å¡«å†™å¯¼å‡ºè·¯å¾„ï¼');
                return;
            }
            
            addExportLog('å¼€å§‹åˆå¹¶LoRAé€‚é…å™¨...');
            addExportLog(`æ£€æŸ¥ç‚¹è·¯å¾„: ${checkpointPath}`);
            addExportLog(`å¯¼å‡ºè·¯å¾„: ${exportPath}`);
            
            try {
                const response = await fetch('/api/merge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        checkpoint_path: checkpointPath,
                        export_path: exportPath
                    })
                });
                
                if (!response.ok) {
                    throw new Error('åˆå¹¶å¤±è´¥');
                }
                
                const result = await response.json();
                addExportLog('åˆå¹¶æˆåŠŸ: ' + result.message);
                
            } catch (error) {
                addExportLog('åˆå¹¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ·»åŠ å¯¼å‡ºæ—¥å¿—
        function addExportLog(message, type = 'info') {
            const logContainer = document.getElementById('exportLogContainer');
            const logEntry = document.createElement('div');
            
            const timestamp = new Date().toLocaleTimeString();
            let color = 'text-green-400';
            let prefix = '>';
            
            if (type === 'error') {
                color = 'text-red-400';
                prefix = 'âœ—';
            }
            
            logEntry.className = color;
            logEntry.textContent = `[${timestamp}] ${prefix} ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // å…¨å±€å˜é‡ï¼šå·²é€‰ä¸­çš„æ•°æ®é›†
        let selectedDatasets = new Set();
        let datasetListVisible = false;

        // åˆ‡æ¢æ•°æ®é›†åˆ—è¡¨æ˜¾ç¤º/éšè—
        function toggleDatasetList() {
            const container = document.getElementById('datasetListContainer');
            const icon = document.getElementById('datasetDropdownIcon');
            
            if (datasetListVisible) {
                // éšè—åˆ—è¡¨
                container.classList.add('hidden');
                icon.classList.remove('rotate-180');
                datasetListVisible = false;
            } else {
                // æ˜¾ç¤ºåˆ—è¡¨
                container.classList.remove('hidden');
                icon.classList.add('rotate-180');
                datasetListVisible = true;
                
                // å¦‚æœåˆ—è¡¨è¿˜æ²¡æœ‰åŠ è½½ï¼Œåˆ™åŠ è½½
                if (container.innerHTML.includes('æ­£åœ¨åŠ è½½')) {
                    loadDatasetList();
                }
            }
        }

        // éšè—æ•°æ®é›†åˆ—è¡¨
        function hideDatasetList() {
            const container = document.getElementById('datasetListContainer');
            const icon = document.getElementById('datasetDropdownIcon');
            container.classList.add('hidden');
            icon.classList.remove('rotate-180');
            datasetListVisible = false;
        }

        // åŠ è½½æ•°æ®é›†åˆ—è¡¨
        async function loadDatasetList() {
            const datasetDir = document.getElementById('datasetDir').value.trim();
            const container = document.getElementById('datasetListContainer');
            
            if (!datasetDir) {
                container.innerHTML = '<p class="text-sm text-gray-500">è¯·è¾“å…¥æ•°æ®é›†ç›®å½•</p>';
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">â³ æ­£åœ¨åŠ è½½æ•°æ®é›†åˆ—è¡¨...</p>';
            
            try {
                const response = await fetch(`/api/datasets?dataset_dir=${encodeURIComponent(datasetDir)}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    container.innerHTML = `<p class="text-sm text-red-500 text-center py-4">âš ï¸ ${result.message || result.error || 'åŠ è½½å¤±è´¥'}</p>`;
                    return;
                }
                
                if (!result.datasets || result.datasets.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">ğŸ“­ è¯¥ç›®å½•ä¸‹æ²¡æœ‰å¯ç”¨çš„æ•°æ®é›†</p>';
                    return;
                }
                
                // æ¸²æŸ“æ•°æ®é›†åˆ—è¡¨ï¼ˆå¸¦å¤é€‰æ¡†ï¼‰
                let html = '<div class="space-y-1">';
                
                result.datasets.forEach(dataset => {
                    const datasetName = typeof dataset === 'string' ? dataset : dataset.name;
                    const isChecked = selectedDatasets.has(datasetName);
                    const formatting = dataset.formatting || '';
                    
                    html += `
                        <label class="flex items-center space-x-2 hover:bg-blue-50 p-2 rounded cursor-pointer transition">
                            <input type="checkbox" 
                                   class="dataset-checkbox rounded text-purple-600 focus:ring-purple-500" 
                                   value="${datasetName}"
                                   ${isChecked ? 'checked' : ''}
                                   onchange="updateSelectedDatasets()">
                            <span class="text-sm text-gray-700 flex-1">${datasetName}</span>
                            ${formatting ? `<span class="text-xs text-gray-500 bg-blue-100 px-2 py-0.5 rounded">${formatting}</span>` : ''}
                        </label>
                    `;
                });
                
                html += '</div>';
                html += `<div class="mt-3 pt-3 border-t flex justify-between items-center">
                            <p class="text-xs text-gray-500">å…± ${result.total} ä¸ªæ•°æ®é›†</p>
                            <button onclick="hideDatasetList()" class="text-xs text-blue-600 hover:text-blue-800">å…³é—­</button>
                         </div>`;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®é›†åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = `<p class="text-sm text-red-500 text-center py-4">âš ï¸ åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // æ›´æ–°å·²é€‰æ‹©çš„æ•°æ®é›†ï¼ˆä»å¤é€‰æ¡†åŒæ­¥åˆ°è¾“å…¥æ¡†ï¼‰
        function updateSelectedDatasets() {
            const checkboxes = document.querySelectorAll('.dataset-checkbox');
            selectedDatasets.clear();
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedDatasets.add(checkbox.value);
                }
            });
            
            // æ›´æ–°æ˜¾ç¤ºæ¡†
            document.getElementById('dataset').value = Array.from(selectedDatasets).join(', ');
        }

        // åŒæ­¥æ•°æ®é›†é€‰æ‹©ï¼ˆä»è¾“å…¥æ¡†åŒæ­¥åˆ°å¤é€‰æ¡†ï¼‰
        function syncDatasetSelection() {
            const inputValue = document.getElementById('dataset').value.trim();
            
            // è§£æè¾“å…¥çš„æ•°æ®é›†åç§°
            const inputDatasets = inputValue
                .split(',')
                .map(s => s.trim())
                .filter(s => s);
            
            // æ›´æ–° selectedDatasets
            selectedDatasets.clear();
            inputDatasets.forEach(name => selectedDatasets.add(name));
            
            // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
            const checkboxes = document.querySelectorAll('.dataset-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectedDatasets.has(checkbox.value);
            });
        }

        // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­ä¸‹æ‹‰åˆ—è¡¨
        document.addEventListener('click', function(event) {
            const container = document.getElementById('datasetListContainer');
            const input = document.getElementById('dataset');
            
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¾“å…¥æ¡†ä¹Ÿä¸æ˜¯ä¸‹æ‹‰åˆ—è¡¨å†…éƒ¨ï¼Œåˆ™å…³é—­åˆ—è¡¨
            if (container && input && 
                !container.contains(event.target) && 
                event.target !== input &&
                datasetListVisible) {
                hideDatasetList();
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initLossChart();
            
            // æ¨¡æ‹Ÿåˆå§‹åŒ–æˆåŠŸ
            setTimeout(() => {
                addLog('Emergency-LLM å¾®è°ƒå¹³å°å·²å°±ç»ª', 'success');
                addLog('è¯·é…ç½®è®­ç»ƒå‚æ•°å¹¶å¼€å§‹è®­ç»ƒ', 'info');
            }, 500);
            
            // é¢„åŠ è½½é»˜è®¤æ•°æ®é›†ç›®å½•çš„æ•°æ®é›†åˆ—è¡¨ï¼ˆåå°åŠ è½½ï¼Œä¸æ˜¾ç¤ºï¼‰
            loadDatasetList();
        });
    </script>
</body>
</html>


